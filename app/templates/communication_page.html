<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Коммуникация</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/communication_page.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>

<body>
    <div class="header">
        <a href="{{ url_for('dashboard.index') }}"><i class="bi bi-arrow-left"></i></a>
        <span class="header-title">Коммуникация</span>
    </div>

    <div class="search-box">
        <input type="text" placeholder="Поиск">
        <button class="search-btn"><i class="bi bi-search"></i></button>
    </div>

    <!-- Закрепленные чаты -->
    <div class="pinned-chats">
        <!-- Чат поддержки VisionTrend доступен для всех ролей -->
        <div class="chat-item pinned">
            <a href="{{ url_for('dashboard.support_chat', chat_id='vt_support') }}" class="chat-link">
                <div class="chat-info">
                    <img src="{{ url_for('static', filename='img/VT-avatar.png') }}" alt="VisionTrend" class="avatar">
                    <div>
                        <div class="chat-name">VisionTrend Support</div>
                        <div class="chat-role">Группа</div>
                    </div>
                </div>
                <span class="pin-icon"><i class="bi bi-pin-fill"></i></span>
            </a>
        </div>

        <!-- Показывать группы компаний-партнеров только для admin, support и соответствующей компании-партнера и их филиалов -->
        {% if role in ['admin', 'support'] %}
            <!-- Для admin и support показываем все группы партнеров -->
            {% for partner in partners %}
            <div class="chat-item pinned">
                <a href="{{ url_for('dashboard.partner_chat', partner_id=partner.id) }}" class="chat-link">
                    <div class="chat-info">
                        <img src="{{ url_for('static', filename='img/' + partner.avatar) }}" alt="{{ partner.name }}" class="avatar">
                        <div>
                            <div class="chat-name">{{ partner.name }} Staff</div>
                            <div class="chat-role">Группа</div>
                        </div>
                    </div>
                    <span class="pin-icon"><i class="bi bi-pin-fill"></i></span>
                </a>
            </div>
            {% endfor %}
        {% elif role in ['store', 'branch'] %}
            <!-- Для партнеров и филиалов показываем только их группу -->
            <div class="chat-item pinned">
                <a href="{{ url_for('dashboard.partner_chat', partner_id=user_company_id) }}" class="chat-link">
                    <div class="chat-info">
                        <img src="{{ url_for('static', filename='img/' + user_company_avatar) }}" alt="{{ user_company }}" class="avatar">
                        <div>
                            <div class="chat-name">{{ user_company }} Staff</div>
                            <div class="chat-role">Группа</div>
                        </div>
                    </div>
                    <span class="pin-icon"><i class="bi bi-pin-fill"></i></span>
                </a>
            </div>
        {% endif %}
    </div>

    <div class="separator"></div>

    <!-- Список контактов в зависимости от роли -->
    <div class="chat-list">
        {% if role in ['admin', 'support'] %}
            <!-- Для admin и support показываем всех пользователей -->
            {% for user in users %}
                {% if user.id != current_user_id %} <!-- Не показываем текущего пользователя -->
                <div class="chat-item">
                    <a href="{{ url_for('dashboard.direct_chat', user_id=user.id) }}" class="chat-link">
                        <div class="chat-info">
                            <img src="{{ url_for('static', filename='img/' + user.avatar) }}" alt="{{ user.name }}" class="avatar">
                            <div>
                                <div class="chat-name">{{ user.name }}</div>
                                <div class="chat-role">{{ user.get_role_display() }}</div>
                            </div>
                        </div>
                    </a>
                    <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
                </div>
                {% endif %}
            {% endfor %}
        {% elif role == 'store' %}
            <!-- Для компании-партнера показываем только филиалы своей компании и поддержку -->
            {% for user in support_users %}
                <div class="chat-item">
                    <a href="{{ url_for('dashboard.direct_chat', user_id=user.id) }}" class="chat-link">
                        <div class="chat-info">
                            <img src="{{ url_for('static', filename='img/' + user.avatar) }}" alt="{{ user.name }}" class="avatar">
                            <div>
                                <div class="chat-name">{{ user.name }}</div>
                                <div class="chat-role">Сотрудник поддержки</div>
                            </div>
                        </div>
                    </a>
                    <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
                </div>
            {% endfor %}

            {% for branch in company_branches %}
                <div class="chat-item">
                    <a href="{{ url_for('dashboard.direct_chat', user_id=branch.id) }}" class="chat-link">
                        <div class="chat-info">
                            <img src="{{ url_for('static', filename='img/' + branch.avatar) }}" alt="{{ branch.name }}" class="avatar">
                            <div>
                                <div class="chat-name">{{ branch.name }}</div>
                                <div class="chat-role">{{ branch.location }}</div>
                            </div>
                        </div>
                    </a>
                    <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
                </div>
            {% endfor %}
        {% elif role == 'branch' %}
            <!-- Для филиалов показываем владельца компании, другие филиалы и поддержку -->
            {% for user in support_users %}
                <div class="chat-item">
                    <a href="{{ url_for('dashboard.direct_chat', user_id=user.id) }}" class="chat-link">
                        <div class="chat-info">
                            <img src="{{ url_for('static', filename='img/' + user.avatar) }}" alt="{{ user.name }}" class="avatar">
                            <div>
                                <div class="chat-name">{{ user.name }}</div>
                                <div class="chat-role">Сотрудник поддержки</div>
                            </div>
                        </div>
                    </a>
                    <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
                </div>
            {% endfor %}

            <!-- Показываем владельца компании -->
            <div class="chat-item">
                <a href="{{ url_for('dashboard.direct_chat', user_id=company_owner.id) }}" class="chat-link">
                    <div class="chat-info">
                        <img src="{{ url_for('static', filename='img/' + company_owner.avatar) }}" alt="{{ company_owner.name }}" class="avatar">
                        <div>
                            <div class="chat-name">{{ company_owner.name }}</div>
                            <div class="chat-role">Владелец компании</div>
                        </div>
                    </div>
                </a>
                <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
            </div>

            <!-- Показываем другие филиалы компании -->
            {% for branch in other_branches %}
                <div class="chat-item">
                    <a href="{{ url_for('dashboard.direct_chat', user_id=branch.id) }}" class="chat-link">
                        <div class="chat-info">
                            <img src="{{ url_for('static', filename='img/' + branch.avatar) }}" alt="{{ branch.name }}" class="avatar">
                            <div>
                                <div class="chat-name">{{ branch.name }}</div>
                                <div class="chat-role">{{ branch.location }}</div>
                            </div>
                        </div>
                    </a>
                    <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Кнопка добавления нового чата (только для admin и support) -->
    {% if role in ['admin', 'support'] %}
    <button class="add-btn">+</button>
    {% endif %}

</body>

</html>